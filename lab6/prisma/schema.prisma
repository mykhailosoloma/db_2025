generator client {
  provider = "prisma-client-js"
}
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model roles {
  role_id   Int     @id @default(autoincrement())
  role_name String  @unique @db.VarChar(50)
  users     users[]
}

model categories {
  category_id   Int       @id @default(autoincrement())
  category_name String    @unique @db.VarChar(100)
  courses       courses[]
}

model content_types {
  content_type_id Int       @id @default(autoincrement())
  type_name       String    @unique @db.VarChar(50)
  lessons         lessons[]
}

model users {
  user_id       Int            @id @default(autoincrement())
  email         String         @unique @db.VarChar(150)
  first_name    String         @db.VarChar(100)
  last_name     String         @db.VarChar(100)
  password_hash String         @db.VarChar(255)
  role_id       Int
  created_at    DateTime?      @default(now()) @db.Timestamp(6)
 
  phone         String?

  roles         roles          @relation(fields: [role_id], references: [role_id], onDelete: Restrict, onUpdate: NoAction)
  certificates  certificates[]
  courses       courses[]
  enrollments   enrollments[]
  reviews       reviews[]
}

model courses {
  course_id     Int            @id @default(autoincrement())
  instructor_id Int
  title         String         @db.VarChar(200)

  summary       String?
  category_id   Int?
  created_at    DateTime?      @default(now()) @db.Timestamp(6)
  
  categories    categories?    @relation(fields: [category_id], references: [category_id], onUpdate: NoAction)
  users         users          @relation(fields: [instructor_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction)
  certificates  certificates[]
  enrollments   enrollments[]
  modules       modules[]
  reviews       reviews[]
}

model modules {
  module_id   Int       @id @default(autoincrement())
  course_id   Int
  title       String    @db.VarChar(200)
  order_index Int
  courses     courses   @relation(fields: [course_id], references: [course_id], onDelete: Cascade, onUpdate: NoAction)
  lessons     lessons[]
}

model lessons {
  lesson_id       Int           @id @default(autoincrement())
  module_id       Int
  title           String        @db.VarChar(200)
  content_type_id Int
  content_data    String?
  order_index     Int
  content_types   content_types @relation(fields: [content_type_id], references: [content_type_id], onUpdate: NoAction)
  modules         modules       @relation(fields: [module_id], references: [module_id], onDelete: Cascade, onUpdate: NoAction)
  progress        progress[]
  
  // Зв'язок з новою таблицею Material
  Material        Material[]
}

model enrollments {
  enrollment_id   Int       @id @default(autoincrement())
  user_id         Int
  course_id       Int
  enrollment_date DateTime? @default(now()) @db.Timestamp(6)
  courses         courses   @relation(fields: [course_id], references: [course_id], onDelete: Cascade, onUpdate: NoAction)
  users           users     @relation(fields: [user_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction)
  progress        progress[]

  @@unique([user_id, course_id], map: "unique_enrollment")
}

model progress {
  progress_id   Int         @id @default(autoincrement())
  enrollment_id Int
  lesson_id     Int
  completed_at  DateTime?   @default(now()) @db.Timestamp(6)
  enrollments   enrollments @relation(fields: [enrollment_id], references: [enrollment_id], onDelete: Cascade, onUpdate: NoAction)
  lessons       lessons     @relation(fields: [lesson_id], references: [lesson_id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([enrollment_id, lesson_id], map: "unique_lesson_progress")
}

model reviews {
  review_id  Int       @id @default(autoincrement())
  user_id    Int?
  course_id  Int
  rating     Int
  comment    String?
  created_at DateTime? @default(now()) @db.Timestamp(6)
  courses    courses   @relation(fields: [course_id], references: [course_id], onDelete: Cascade, onUpdate: NoAction)
  users      users?    @relation(fields: [user_id], references: [user_id], onUpdate: NoAction)

  @@unique([user_id, course_id], map: "unique_review_per_course")
}

model certificates {
  certificate_id  Int       @id @default(autoincrement())
  user_id         Int
  course_id       Int
  issue_date      DateTime? @default(dbgenerated("CURRENT_DATE")) @db.Date
  certificate_url String    @unique @db.VarChar(255)
  courses         courses   @relation(fields: [course_id], references: [course_id], onDelete: Cascade, onUpdate: NoAction)
  users           users     @relation(fields: [user_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction)
}

model Material {
  material_id Int      @id @default(autoincrement())
  title       String
  url         String
  lesson_id   Int
  lesson      lessons  @relation(fields: [lesson_id], references: [lesson_id])
}